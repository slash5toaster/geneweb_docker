Bootstrap: docker
From: debian:unstable-slim
Stage: spython-base

###############################################################################
%files
opt/geneweb/startup.sh {{ GW_ROOT }}/
# opt/geneweb/bashrc {{ GW_ROOT }}/.bashrc

###############################################################################
%labels
   org.opencontainers.image.vendor=slash5toaster
   org.opencontainers.image.authors=slash5toaster@gmail.com
   org.opencontainers.image.ref.name=geneweb
   org.opencontainers.image.version={{ GW_VER }}
###############################################################################
%post
GW_VER={{ GW_VER }}
GW_PR={{ GW_PR }}

GW_USER={{ GW_USER }}
GW_GROUP={{ GW_GROUP }}
GW_UID={{ GW_UID }}
GW_GID={{ GW_GID }}

GW_ROOT={{ GW_ROOT }}

GWD_PORT={{ GWD_PORT }}
GWC_PORT={{ GWC_PORT }}

# Add geneweb user
groupadd {{ GW_GROUP }} \
          -g {{ GW_GID }}

useradd {{ GW_USER }} \
        -r \
        -u {{ GW_UID }} \
        -g {{ GW_GROUP }} \
        -m -d {{ GW_ROOT }} \
        -s /bin/bash

pwck -s
grpck -s

# Update OS to apply latest vulnerability fix
apt-get update && \
apt-get install -y \
        bubblewrap \
        build-essential \
        curl \
        gcc \
        git \
        libcurl4-gnutls-dev \
        libgmp-dev \
        m4 \
        make \
        ocaml \
        procps \
        rsync \
        wget \
        unzip

apt-get install -y \
        opam

# make geneweb
cd /tmp/

wget -c https://github.com/geneweb/geneweb/releases/download/{{ GW_VER }}/geneweb-linux.zip \
     -O /tmp/geneweb-linux-{{ GW_VER }}.zip \
  && cd {{ GW_ROOT }} \
  && unzip /tmp/geneweb-linux-{{ GW_VER }}.zip \
  && mv -v {{ GW_ROOT }}/* {{ GW_ROOT }} \
  && rm -v /tmp/geneweb-linux-{{ GW_VER }}.zip

chown -cR {{ GW_USER }}.{{ GW_GROUP }} {{ GW_ROOT }}

su - {{ GW_USER }}
cd {{ GW_ROOT }}

###############################################################################
%environment
export GW_VER={{ GW_VER }}
export GW_PR={{ GW_PR }}
export GW_USER={{ GW_USER }}
export GW_GROUP={{ GW_GROUP }}
export GW_UID={{ GW_UID }}
export GW_GID={{ GW_GID }}
export GW_ROOT={{ GW_ROOT }}
export GWD_PORT={{ GWD_PORT }}
export GWC_PORT={{ GWC_PORT }}

###############################################################################
%runscript
cd {{ GW_ROOT }}
#/opt/geneweb/startup.sh "$@"

###############################################################################
%startscript
cd {{ GW_ROOT }}
{{ GW_ROOT }}/gwd -help

###############################################################################
%test
{{ GW_ROOT }}/gw/gwd -version
